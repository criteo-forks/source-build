sudo: required
services:
- docker
git:
  submodules: false
before_install:
- sudo apt-get update
- echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"'
  | sudo tee /etc/default/docker > /dev/null
- sudo service docker restart
- sleep 5
script:
- gem install octokit
- travis_wait 60 ./criteo-build-centos7.sh $TRAVIS_BRANCH # TRAVIS_BRANCH == TRAVIS_TAG when tag is pushed but TRAVIS_TAG might be empty on build only

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true  
  file: bin/obj/x64/Release/blob-feed/assets/dotnet-runtime-*.tar.gz
  skip_cleanup: true
  on:
    repo: criteo-forks/source-build
    tags: true

after_deploy:
    - ./generate_changelog_and_update_release.sh $TRAVIS_TAG $GITHUB_TOKEN 
